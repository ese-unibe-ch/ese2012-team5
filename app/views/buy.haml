%link(rel="stylesheet" type="text/css" href="/style.css")


%h1 Buy(we need some sexy title here)
%br

-if info != nil
  %h2 #{info}
  %br

-# we need to store how many (the quantity) times the user want to buy a specific item
-# my first idea is, that we use a map therefore
-# we map every item to its wanted quantity
-# we wil use this map for calculating the whole transaction
-map = Hash.new

-total = 0
-slider_count = items.length
-count = 0


:javascript
  var global_total = 0;
  var indexToId = {}

%table#table_new
  -for item in items
    -if quantity >= item.quantity
      -quantity_for_this_item = item.quantity
      -quantity = quantity - item.quantity
    -else
      -quantity_for_this_item = quantity
      -quantity = 0

    -map[item] = quantity_for_this_item
    -total = total + (item.price * quantity_for_this_item)

    :javascript
      indexToId['#{count}'] = #{item.id};
        $(function() {

          $( "#slider#{count}" ).slider( {
            value:#{quantity_for_this_item},
            min: 0,
            max: #{item.quantity},
            step: 1,
            slide: function( event, ui ) {
              $( "#amount#{item.id}" ).val( ui.value );
              $( "#total#{item.id}" ).val( ui.value * #{item.price} );
              global_total = 0;
              update();
            }
          });
          $( "#amount#{item.id}" ).val( $( "#slider#{count}"  ).slider( "value" ) );
          $( "#total#{item.id}" ).val( ($( "#slider#{count}"  ).slider( "value" )) * #{item.price} );
        });

        function update() {

          var global_total = 0;
          $("[id^=total]").each(function(){
          global_total += parseInt($(this).val());
          })
          $( "#global_total" ).val( global_total );
        }

    %tr
      %td{:height => "200", :width => "200"}
        %img{:height => "200", :width => "200", :src => "../item_image_upload/#{item.pictures[0]}"}
      %td
        #{item.name}
        %br
        #{item.owner.name}
    %tr
      %td
        %div(id="slider#{count}")
        %input( type="text" readonly="readonly" id="amount#{item.id}")
        of
        #{item.quantity}
      %td
        Ã  #{item.price}
    %tr
      %td{:colspan => 2, :align => "right"}
        Total:
        %input( type="text" readonly="readonly" id="total#{item.id}")
    -count = count + 1
    -break if quantity == 0

  %tr
    %td
      -if quantity != 0
        That's all... I'm sorry
    %td{:colspan => 2, :align => "right"}
      Total: #{total}
      %input(type='text' readonly="readonly" id='global_total')


  %tr
    %td
      %form(action = "/" method = "GET")
        %input(type='submit' value='Abort')
      %td{:align => "right"}
        %form(action = "/buy/confirm" method = "POST")
          -x = 0
          -map.each do |item,quantity|
            %input(type='hidden' name="id#{x}" value="#{item.id}")
            %input(type='hidden'  id="amount#{item.id}")
            -#no idea how to make that yet, i dont get how the $("something") variables are saved and can be acssesed
            -x = x + 1
          %input(type='submit' value='Continue')
